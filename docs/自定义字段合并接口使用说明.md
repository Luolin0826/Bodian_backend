# 自定义字段合并接口使用说明

## 🎯 问题解决

**解决双请求问题**：将原本需要的两个请求合并为一个，提升性能和用户体验。

### 原有方案（双请求）❌
```javascript
// 请求1：获取字段定义
const definitions = await fetch('/api/v1/custom-fields/manage/basic?province=广东省')

// 请求2：获取字段值  
const values = await fetch('/api/v1/custom-fields/values/1?section=basic&province=广东省')

// 前端手动合并数据...
```

### 新方案（单请求）✅
```javascript
// 一个请求获取完整数据
const response = await fetch('/api/v1/custom-fields/values/1?section=basic&province=广东省&include_definitions=true')
```

## 📋 API规格说明

### 端点
```http
GET /api/v1/custom-fields/values/{unit_id}
```

### 参数
| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `unit_id` | int | ✅ | 单位ID（路径参数） |
| `section` | string | ❌ | 板块筛选（basic/early-batch等） |
| `province` | string | ❌ | 省份筛选（需URL编码） |
| `include_definitions` | boolean | ❌ | 是否包含字段定义（默认false） |

### 响应格式

#### 新格式（include_definitions=true）
```json
{
  "success": true,
  "data": {
    "fields": [
      {
        // 字段定义信息
        "field_id": 3,
        "field_name": "custom_1757226925033", 
        "display_name": "发展前景",
        "field_type": "text",
        "field_content": "模板内容",
        "section": "basic",
        "province": "广东省",
        "is_required": false,
        "display_order": 1,
        "field_options": null,
        "validation_rules": null,
        "is_visible": true,
        
        // 字段值信息
        "field_value": "单位1的发展前景内容",
        "value_updated_at": "2025-09-07T09:41:27.000Z",
        "has_value": true
      }
    ],
    "unit_id": 1,
    "total_fields": 3,
    "fields_with_values": 2,
    "filter_applied": {
      "section": "basic",
      "province": "广东省"
    }
  }
}
```

#### 原有格式（include_definitions=false，默认）
```json
{
  "success": true, 
  "field_values": {
    "basic": [
      {
        "field_id": 3,
        "field_name": "custom_xxx",
        "display_name": "发展前景",
        "field_type": "text", 
        "field_value": "单位1的内容"
      }
    ]
  }
}
```

## 🚀 使用示例

### 1. 获取完整字段信息（推荐）
```javascript
// 获取单位1的基本板块广东省字段（包含定义和值）
const response = await fetch('/api/v1/custom-fields/values/1?section=basic&province=广东省&include_definitions=true')
const data = await response.json()

if (data.success) {
  data.data.fields.forEach(field => {
    console.log(`${field.display_name}: ${field.field_value || '未填写'}`)
    console.log(`字段类型: ${field.field_type}, 是否必填: ${field.is_required}`)
  })
}
```

### 2. 批量字段编辑场景
```javascript
// 加载字段进行编辑
const loadFieldsForEdit = async (unitId) => {
  const response = await fetch(`/api/v1/custom-fields/values/${unitId}?section=basic&include_definitions=true`)
  const data = await response.json()
  
  return data.data.fields.map(field => ({
    fieldName: field.field_name,
    displayName: field.display_name, 
    fieldType: field.field_type,
    currentValue: field.field_value || '',
    isRequired: field.is_required,
    hasValue: field.has_value
  }))
}

// 保存字段值（使用现有PUT接口）
const saveFieldValues = async (unitId, fieldValues) => {
  await fetch(`/api/v1/custom-fields/values/${unitId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      section: 'basic',
      field_values: fieldValues
    })
  })
}
```

### 3. 不同板块的字段管理
```javascript
// 获取不同板块的字段
const sections = ['basic', 'early-batch', 'rural-grid', 'regional']

const fieldsBySection = {}
for (const section of sections) {
  const response = await fetch(`/api/v1/custom-fields/values/1?section=${section}&include_definitions=true`)
  const data = await response.json()
  fieldsBySection[section] = data.data.fields
}
```

### 4. 省份特定字段显示
```javascript
// 根据用户选择的省份显示相关字段
const loadProvinceFields = async (unitId, province) => {
  const encodedProvince = encodeURIComponent(province)
  const response = await fetch(`/api/v1/custom-fields/values/${unitId}?province=${encodedProvince}&include_definitions=true`)
  
  return response.json()
}

// 示例：加载广东省的字段
const guangdongFields = await loadProvinceFields(1, '广东省')
```

## 🔧 向后兼容性

✅ **完全兼容**：现有代码无需修改，只需在需要合并数据时添加`include_definitions=true`参数。

```javascript
// 现有代码继续工作
const oldWay = await fetch('/api/v1/custom-fields/values/1?section=basic')

// 新功能可选启用
const newWay = await fetch('/api/v1/custom-fields/values/1?section=basic&include_definitions=true')
```

## 📊 性能对比

| 方案 | 网络请求 | 数据传输量 | 前端处理复杂度 | 用户体验 |
|------|----------|------------|----------------|----------|
| 双请求（原有） | 2次 | 较高 | 高（需合并数据） | 较慢 |
| 单请求（新） | 1次 | 优化 | 低（直接使用） | ⚡快速 |

## 🎨 数据字段说明

### 字段定义部分
- `field_content`: 字段模板内容（管理员设置）
- `display_name`: 字段显示名称
- `field_type`: 字段类型（text/textarea/select等）
- `is_required`: 是否必填
- `province`: 省份归属

### 字段值部分
- `field_value`: 该单位的实际字段值
- `has_value`: 是否有值（布尔值）
- `value_updated_at`: 值的更新时间

## 🔍 筛选功能

支持灵活的筛选组合：

1. **按板块筛选**：`?section=basic`
2. **按省份筛选**：`?province=广东省` 
3. **组合筛选**：`?section=basic&province=广东省`
4. **获取全部**：不加筛选参数

前端现在只需要一个API调用即可获取完整的字段信息，大大简化了数据处理流程！